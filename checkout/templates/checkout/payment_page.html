{% extends "base.html" %}
{% block content %}

<div class="container py-5" style="max-width: 600px;">
    <h2 class="mb-4 text-center">Complete Your Payment</h2>

    <p><strong>Order ID:</strong> {{ order.id }}</p>
    <p><strong>Total:</strong> €{{ order.total_eur }}</p>

    <hr>

    <!-- Stripe Card Element -->
    <form id="payment-form">
        

        <!-- Cardholder Name -->
        <div class="mb-3">
            <label for="cardholder-name" class="form-label">Cardholder Name</label>
            <input class="form-control" id="cardholder-name" name="cardholder-name" type="text" placeholder="Full name"
                required>
        </div>

        <!-- Email -->
        <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input class="form-control" id="email" name="email" type="email" value="{{ request.user.email }}"
                placeholder="Email" required>
        </div>

        <!-- Card Element -->
        <div class="mb-3">
            <label class="form-label">Card Details</label>
            <div id="card-element" class="form-control" style="height: 40px; padding-top: 10px;"></div>
        </div>

        <!-- Error -->
        <div id="error-message" class="text-danger mt-2"></div>

        <button id="submit-button" class="btn btn-primary w-100">
            Pay €{{ order.total_eur }}
        </button>
    </form>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ stripe_public_key }}");
    const elements = stripe.elements();

    const card = elements.create("card", {
        hidePostalCode: true
    });
    card.mount("#card-element");

    const form = document.getElementById("payment-form");

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        stripe.confirmCardPayment("{{ client_secret }}", {
            payment_method: {
                card: card,
                billing_details: {
                        name: name,
                        email: email,
                    }
            }
        }).then(function (result) {
            if (result.error) {
                document.getElementById("card-errors").textContent = result.error.message;
            } else {
                if (result.paymentIntent.status === "succeeded") {
                    window.location.href = "{% url 'checkout_success' %}";
                }
            }
        });
    });
</script>

{% endblock %}