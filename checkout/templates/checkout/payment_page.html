{% extends "base.html" %}
{% block content %}

<div class="container py-5" style="max-width: 600px;">
    <h2 class="mb-4 text-center">Complete Your Payment</h2>

    <div class="card shadow-sm p-4">

        <p><strong>Order ID:</strong> {{ order.id }}</p>
        <p><strong>Total:</strong> €{{ order.total_eur }}</p>

        <hr>

        <!-- Stripe Card Element -->
        <form id="payment-form" novalidate>


            <!-- Cardholder Name -->
            <div class="mb-3">
                <label for="cardholder-name" class="form-label">Cardholder Name</label>
                <input class="form-control" id="cardholder-name" name="cardholder-name" type="text"
                    placeholder="Full name" required>
                <div class="invalid-feedback">Please enter your full name (first & last).</div>
            </div>

            <!-- Email -->
            <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input class="form-control" id="email" name="email" type="email" value="{{ request.user.email }}"
                    placeholder="Email" required>
                <div class="invalid-feedback">Please enter a valid email address.</div>
            </div>

            <!-- Country -->
            <div class="mb-3">
                <label for="country" class="form-label">Country</label>
                <select id="country" name="country" class="form-select" required>
                    <option value="">Select your country</option>
                    <option value="IE">Ireland</option>
                    <option value="BE">Belgium</option>
                    <option value="CH">Switzerland</option>
                    <option value="ES">Spain</option>
                    <option value="DE">Germany</option>
                    <option value="IT">Italy</option>
                    <option value="NL">Netherlands</option>
                    <option value="GB">United Kingdom</option>
                    <option value="US">United States</option>
                </select>
                <div class="invalid-feedback">Please select a country.</div>
            </div>

            <!-- Card Element -->
            <div class="mb-3">
                <label class="form-label">Card Details</label>
                <div id="card-element" class="form-control" style="height: 40px; padding-top: 10px;"></div>
            </div>

            <!-- Error -->
            <div id="error-message" class="text-danger mt-2"></div>

            <button id="submit-button" class="btn btn-primary w-100">
                Pay €{{ order.total_eur|floatformat:2 }}
            </button>
        </form>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>

<script>
    const stripe = Stripe("{{ stripe_public_key }}");

    const elements = stripe.elements({
        appearance: { theme: "stripe" }
    });

    const card = elements.create("card", {
        hidePostalCode: true
    });
    card.mount("#card-element");

    const form = document.getElementById("payment-form");
    const submitButton = document.getElementById("submit-button");
    const errorMessage = document.getElementById("error-message");

    // Validate input before Stripe request
    function validateInputs() {
        let valid = true;

        const nameField = document.getElementById("cardholder-name");
        const emailField = document.getElementById("email");
        const countryField = document.getElementById("country");

        // Full name requires at least 2 words
        if (!nameField.value.trim().includes(" ")) {
            nameField.classList.add("is-invalid");
            valid = false;
        } else {
            nameField.classList.remove("is-invalid");
        }

        if (!emailField.value.trim().includes("@")) {
            emailField.classList.add("is-invalid");
            valid = false;
        } else {
            emailField.classList.remove("is-invalid");
        }

        if (!countryField.value) {
            countryField.classList.add("is-invalid");
            valid = false;
        } else {
            countryField.classList.remove("is-invalid");
        }

        return valid;
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMessage.textContent = "";
        if (!validateInputs()) return;

        submitButton.disabled = true;
        submitButton.textContent = "Processing…";

        const name = document.getElementById("cardholder-name").value.trim();
        const email = document.getElementById("email").value;
        const country = document.getElementById("country").value;

        const { error, paymentIntent } = await stripe.confirmCardPayment(
            "{{ client_secret }}",
            {
                payment_method: {
                    card: card,
                    billing_details: {
                        name: name,
                        email: email,
                        address: { country: country }
                    }
                }
            }
        );

        if (error) {
            errorMessage.textContent = error.message;
            submitButton.disabled = false;
            submitButton.textContent = "Pay €{{ order.total_eur }}";
        } else if (paymentIntent.status === "succeeded") {
            window.location.href = "{% url 'checkout_success' %}";
        }
    });
</script>

{% endblock %}